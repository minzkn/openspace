{% extends "layout.html" %}
{% block title %}{{ template.name }} 편집 - OpenSpace{% endblock %}
{% block page_title %}서식 편집: {{ template.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/lib/jsuites.css">
<link rel="stylesheet" href="/static/lib/jspreadsheet.css">
<style>
.editor-topbar { display:flex; align-items:center; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
.editor-topbar .left { flex:1; display:flex; align-items:center; gap:8px; }
.sheet-tabs-wrap { display:flex; align-items:center; gap:2px; border-bottom:2px solid var(--border); padding-bottom:0; margin-bottom:4px; overflow-x:auto; }
.sheet-tab { display:flex; align-items:center; gap:4px; padding:5px 12px; border:1px solid var(--border); border-bottom:none; border-radius:4px 4px 0 0; cursor:pointer; font-size:13px; background:var(--bg); white-space:nowrap; }
.sheet-tab.active { background:var(--surface); border-color:var(--primary); color:var(--primary); font-weight:600; }
.sheet-tab .tab-del { font-size:14px; color:#94a3b8; cursor:pointer; padding:0 2px; line-height:1; }
.sheet-tab .tab-del:hover { color:var(--danger); }
.sheet-add-btn { padding:5px 10px; border:1px dashed var(--border); border-radius:4px; cursor:pointer; font-size:18px; color:var(--text-muted); background:none; }
.sheet-add-btn:hover { color:var(--primary); border-color:var(--primary); }

/* 컬럼 속성 패널 */
.col-panel { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:12px; margin-bottom:8px; display:none; }
.col-panel.visible { display:block; }
.col-panel-title { font-weight:600; margin-bottom:10px; font-size:13px; color:var(--text-muted); }
.col-panel-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.col-panel-row label { font-size:12px; font-weight:500; min-width:60px; }
.col-panel-row input, .col-panel-row select { padding:4px 8px; border:1px solid var(--border); border-radius:4px; font-size:13px; }
.col-panel-row input[type=number] { width:80px; }
.col-panel-row .sep { color:var(--border); }

#spreadsheet-wrap { position:relative; }
.save-indicator { position:fixed; bottom:16px; right:16px; background:#0f172a; color:#fff; padding:6px 14px; border-radius:20px; font-size:12px; opacity:0; transition:opacity .3s; pointer-events:none; z-index:999; }
.save-indicator.show { opacity:1; }
</style>
{% endblock %}

{% block content %}
<!-- 상단 툴바 -->
<div class="editor-topbar">
  <div class="left">
    <a href="/admin/templates" class="btn btn-ghost btn-sm">&larr; 목록</a>
    <span style="color:var(--text-muted)">|</span>
    <strong id="tmpl-name-display">{{ template.name }}</strong>
  </div>
  <div style="display:flex;gap:6px;flex-wrap:wrap">
    <button class="btn btn-sm btn-secondary" onclick="addColumn()">+ 컬럼 추가</button>
    <button class="btn btn-sm btn-secondary" onclick="showColPanel()">컬럼 속성</button>
    <button class="btn btn-sm btn-secondary" onclick="downloadTemplate()">xlsx 다운로드</button>
    <button class="btn btn-sm btn-secondary" onclick="printSheet()">인쇄</button>
    <span id="save-status" style="font-size:12px;color:var(--text-muted);align-self:center"></span>
  </div>
</div>

<!-- 컬럼 속성 패널 -->
<div class="col-panel" id="col-panel">
  <div class="col-panel-title">선택 컬럼 속성 (컬럼 헤더 클릭 후 적용)</div>
  <div class="col-panel-row">
    <label>헤더명</label>
    <input type="text" id="cp-header" placeholder="컬럼명">
    <span class="sep">|</span>
    <label>타입</label>
    <select id="cp-type">
      <option value="text">텍스트</option>
      <option value="number">숫자</option>
      <option value="date">날짜</option>
      <option value="checkbox">체크박스</option>
    </select>
    <span class="sep">|</span>
    <label>너비</label>
    <input type="number" id="cp-width" value="120" min="40" max="500">
    <span class="sep">|</span>
    <label style="min-width:auto"><input type="checkbox" id="cp-readonly"> 읽기전용</label>
    <button class="btn btn-sm btn-primary" onclick="applyColProps()">적용</button>
    <button class="btn btn-sm btn-danger" onclick="deleteColumn()">컬럼 삭제</button>
  </div>
</div>

<!-- 시트 탭 -->
<div class="sheet-tabs-wrap" id="sheet-tabs"></div>

<!-- 포맷 툴바 -->
<div class="format-toolbar" id="format-toolbar">
  <!-- 글꼴 크기 -->
  <select class="fmt-select" id="fmt-font-size" title="글꼴 크기" onchange="fmtFontSize(this.value)">
    <option value="8">8</option><option value="9">9</option><option value="10">10</option>
    <option value="11" selected>11</option><option value="12">12</option><option value="14">14</option>
    <option value="16">16</option><option value="18">18</option><option value="20">20</option>
    <option value="24">24</option><option value="36">36</option>
  </select>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-bold" title="굵게 (Ctrl+B)" onclick="fmtBold()"><b>B</b></button>
  <button class="fmt-btn" id="fmt-italic" title="기울임 (Ctrl+I)" onclick="fmtItalic()"><i>I</i></button>
  <button class="fmt-btn" id="fmt-underline" title="밑줄 (Ctrl+U)" onclick="fmtUnderline()"><u>U</u></button>
  <button class="fmt-btn" id="fmt-strikethrough" title="취소선" onclick="fmtStrikethrough()"><s>S</s></button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-color" title="글자색" onclick="toggleDropdown('color-drop')" style="position:relative">
    A<span class="color-bar" id="fmt-color-bar" style="background:#000000"></span>
    <div class="fmt-dropdown" id="color-drop">
      <div class="color-swatches" id="color-swatches"></div>
      <div class="fmt-dropdown-item" onclick="fmtColor(null)">자동 (기본색)</div>
    </div>
  </button>
  <button class="fmt-btn" id="fmt-bg" title="배경색" onclick="toggleDropdown('bg-drop')" style="position:relative">
    <span style="font-size:15px">&#x1f3a8;</span><span class="color-bar" id="fmt-bg-bar" style="background:transparent;border:1px solid #ccc"></span>
    <div class="fmt-dropdown" id="bg-drop">
      <div class="color-swatches" id="bg-swatches"></div>
      <div class="fmt-dropdown-item" onclick="fmtBg(null)">없음 (배경 제거)</div>
    </div>
  </button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-align-left" title="왼쪽 정렬" onclick="fmtAlign('left')">&#x2b05;</button>
  <button class="fmt-btn" id="fmt-align-center" title="가운데 정렬" onclick="fmtAlign('center')">&#x2261;</button>
  <button class="fmt-btn" id="fmt-align-right" title="오른쪽 정렬" onclick="fmtAlign('right')">&#x27a1;</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-valign-top" title="위쪽 정렬" onclick="fmtValign('top')">&#x2191;</button>
  <button class="fmt-btn" id="fmt-valign-middle" title="가운데 정렬" onclick="fmtValign('middle')">&#x2195;</button>
  <button class="fmt-btn" id="fmt-valign-bottom" title="아래쪽 정렬" onclick="fmtValign('bottom')">&#x2193;</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-wrap" title="줄바꿈" onclick="fmtWrap()">&#x21b5;</button>
  <div class="fmt-sep"></div>
  <!-- 숫자 서식 -->
  <select class="fmt-select" id="fmt-num-format" title="숫자 서식" onchange="fmtNumFormat(this.value)">
    <option value="">일반</option>
    <option value="#,##0">숫자 (#,##0)</option>
    <option value="#,##0.00">소수점 (#,##0.00)</option>
    <option value="0.00%">백분율 (0.00%)</option>
    <option value="&#x20A9;#,##0">통화 (&#x20A9;)</option>
    <option value="yyyy-mm-dd">날짜</option>
    <option value="yyyy-mm-dd hh:mm">날짜/시간</option>
  </select>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" title="셀 병합" onclick="fmtMerge()">&#x229e;</button>
  <button class="fmt-btn" title="병합 해제" onclick="fmtUnmerge()">&#x229f;</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" title="테두리" onclick="toggleDropdown('border-drop')" style="position:relative">
    &#x22a1;
    <div class="fmt-dropdown" id="border-drop" style="min-width:180px">
      <div class="fmt-dropdown-item" onclick="fmtBorderStyled('all')">모든 테두리</div>
      <div class="fmt-dropdown-item" onclick="fmtBorderStyled('outer')">바깥 테두리</div>
      <div class="fmt-dropdown-item" onclick="fmtBorderStyled('bottom')">아래쪽</div>
      <div class="fmt-dropdown-item" onclick="fmtBorderStyled('top')">위쪽</div>
      <div class="fmt-dropdown-item" onclick="fmtBorderStyled('left')">왼쪽</div>
      <div class="fmt-dropdown-item" onclick="fmtBorderStyled('right')">오른쪽</div>
      <div class="fmt-dropdown-item" onclick="fmtBorder('none')">테두리 없음</div>
      <div class="fmt-dropdown-sep"></div>
      <div style="padding:4px 8px;display:flex;gap:6px;align-items:center;font-size:12px">
        <label>스타일</label>
        <select id="border-style-select" style="font-size:11px;padding:2px">
          <option value="thin">얇게</option>
          <option value="medium">중간</option>
          <option value="thick">두껍게</option>
          <option value="dashed">점선</option>
          <option value="dotted">점</option>
        </select>
        <input type="hidden" id="border-color-val" value="000000">
      </div>
    </div>
  </button>
</div>

<!-- 수식 입력줄 -->
<div class="formula-bar" id="formula-bar">
  <div class="formula-cell-ref" id="formula-cell-ref">A1</div>
  <div class="formula-fx">fx</div>
  <input type="text" class="formula-input" id="formula-input" placeholder="셀 값 또는 수식 입력">
</div>

<!-- 찾기/바꾸기 패널 -->
<div class="find-panel" id="find-panel">
  <div class="find-row">
    <input type="text" id="find-input" placeholder="찾기..." class="find-input" onkeydown="if(event.key==='Enter'){findNext();event.preventDefault()}">
    <button class="btn btn-sm btn-ghost" onclick="findPrev()" title="이전">&#x25b2;</button>
    <button class="btn btn-sm btn-ghost" onclick="findNext()" title="다음">&#x25bc;</button>
    <span id="find-count" class="find-count">결과 없음</span>
    <label class="find-option"><input type="checkbox" id="find-case"> 대소문자</label>
    <button class="btn btn-sm btn-ghost" onclick="SpreadsheetCore.closeFindPanel()" title="닫기">&#x2715;</button>
  </div>
  <div class="find-row" id="find-replace-row" style="display:none">
    <input type="text" id="replace-input" placeholder="바꾸기..." class="find-input">
    <button class="btn btn-sm btn-ghost" onclick="replaceCurrent()">바꾸기</button>
    <button class="btn btn-sm btn-ghost" onclick="replaceAll()">모두 바꾸기</button>
  </div>
</div>

<!-- 스프레드시트 -->
<div id="spreadsheet-wrap">
  <div id="spreadsheet"></div>
</div>

<!-- 상태 표시줄 -->
<div class="status-bar" id="status-bar"></div>

<div class="save-indicator" id="save-indicator">저장 중...</div>

<!-- 시트 이름 변경 모달 -->
<template id="rename-sheet-tpl">
  <form onsubmit="submitRenameSheet(event)" style="display:flex;flex-direction:column;gap:12px">
    <div class="form-group">
      <label>시트 이름</label>
      <input type="text" id="f-sheet-name" required>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-ghost" onclick="closeModal()">취소</button>
      <button type="submit" class="btn btn-primary">변경</button>
    </div>
  </form>
</template>

<script id="template-data" type="application/json">{{ template_data_json | safe }}</script>
{% endblock %}

{% block scripts %}
<script src="/static/lib/jsuites.js"></script>
<script src="/static/lib/jspreadsheet.js"></script>
<script src="/static/lib/jspreadsheet-formula.js"></script>
<script src="/static/js/spreadsheet_core.js"></script>
<script src="/static/js/template_edit.js"></script>
{% endblock %}
