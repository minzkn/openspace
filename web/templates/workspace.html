{% extends "layout.html" %}
{% block title %}{{ workspace.name }} - OpenSpace{% endblock %}
{% block page_title %}{{ workspace.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsuites/dist/jsuites.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4/dist/jspreadsheet.css">
{% endblock %}

{% block content %}
<div class="workspace-header">
  <div class="workspace-info">
    <span class="badge {{ workspace.status|lower }}" id="ws-status-badge">{{ workspace.status }}</span>
    <span id="ws-conn-indicator" class="conn-dot disconnected" title="ì—°ê²° ìƒíƒœ"></span>
    <span id="ws-activity" class="ws-activity"></span>
  </div>
  <div class="workspace-actions">
    <button class="btn btn-sm btn-secondary" onclick="exportWorkspace()">ë‹¤ìš´ë¡œë“œ</button>
    {% if is_admin %}
    <label class="btn btn-sm btn-secondary">
      ì—…ë¡œë“œ
      <input type="file" accept=".xlsx" style="display:none" onchange="importWorkspace(this)">
    </label>
    <button class="btn btn-sm btn-danger" id="close-btn" onclick="toggleClose()">
      {% if workspace.status == 'OPEN' %}ë§ˆê°{% else %}ì¬ê°œ{% endif %}
    </button>
    {% endif %}
  </div>
</div>

<!-- ì‹œíŠ¸ íƒ­ -->
<div class="sheet-tabs-row">
  <div class="sheet-tabs" id="sheet-tabs"></div>
  {% if is_admin %}
  <button class="btn btn-sm btn-ghost" onclick="addWsSheet()" title="ì‹œíŠ¸ ì¶”ê°€" style="padding:4px 8px;font-size:18px">+</button>
  {% endif %}
</div>

<!-- í¬ë§· íˆ´ë°” (ê´€ë¦¬ì ë° í¸ì§‘ ê°€ëŠ¥ ìƒíƒœì—ì„œ í‘œì‹œ) -->
<div class="format-toolbar" id="format-toolbar" style="display:none">
  <button class="fmt-btn" id="fmt-bold" title="êµµê²Œ" onclick="fmtBold()"><b>B</b></button>
  <button class="fmt-btn" id="fmt-italic" title="ê¸°ìš¸ì„" onclick="fmtItalic()"><i>I</i></button>
  <button class="fmt-btn" id="fmt-underline" title="ë°‘ì¤„" onclick="fmtUnderline()"><u>U</u></button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-color" title="ê¸€ììƒ‰" onclick="toggleDropdown('color-drop')" style="position:relative">
    A<span class="color-bar" id="fmt-color-bar" style="background:#000000"></span>
    <div class="fmt-dropdown" id="color-drop">
      <div class="color-swatches" id="color-swatches"></div>
      <div class="fmt-dropdown-item" onclick="fmtColor(null)">ìë™ (ê¸°ë³¸ìƒ‰)</div>
    </div>
  </button>
  <button class="fmt-btn" id="fmt-bg" title="ë°°ê²½ìƒ‰" onclick="toggleDropdown('bg-drop')" style="position:relative">
    ğŸ¨<span class="color-bar" id="fmt-bg-bar" style="background:transparent;border:1px solid #ccc"></span>
    <div class="fmt-dropdown" id="bg-drop">
      <div class="color-swatches" id="bg-swatches"></div>
      <div class="fmt-dropdown-item" onclick="fmtBg(null)">ì—†ìŒ (ë°°ê²½ ì œê±°)</div>
    </div>
  </button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-align-left" title="ì™¼ìª½ ì •ë ¬" onclick="fmtAlign('left')">â¬…</button>
  <button class="fmt-btn" id="fmt-align-center" title="ê°€ìš´ë° ì •ë ¬" onclick="fmtAlign('center')">â‰¡</button>
  <button class="fmt-btn" id="fmt-align-right" title="ì˜¤ë¥¸ìª½ ì •ë ¬" onclick="fmtAlign('right')">â¡</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-wrap" title="ì¤„ë°”ê¿ˆ" onclick="fmtWrap()">â†µ</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" title="ì…€ ë³‘í•©" onclick="fmtMerge()">âŠ</button>
  <button class="fmt-btn" title="ë³‘í•© í•´ì œ" onclick="fmtUnmerge()">âŠŸ</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" title="í…Œë‘ë¦¬" onclick="toggleDropdown('border-drop')" style="position:relative">
    âŠ¡
    <div class="fmt-dropdown" id="border-drop">
      <div class="fmt-dropdown-item" onclick="fmtBorder('all')">ëª¨ë“  í…Œë‘ë¦¬</div>
      <div class="fmt-dropdown-item" onclick="fmtBorder('outer')">ë°”ê¹¥ í…Œë‘ë¦¬</div>
      <div class="fmt-dropdown-item" onclick="fmtBorder('none')">í…Œë‘ë¦¬ ì—†ìŒ</div>
      <div class="fmt-dropdown-item" onclick="fmtBorder('bottom')">ì•„ë˜ìª½ë§Œ</div>
    </div>
  </button>
</div>

<!-- ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì»¨í…Œì´ë„ˆ -->
<div id="spreadsheet-container">
  <div id="spreadsheet"></div>
</div>

<!-- CLOSED ì˜¤ë²„ë ˆì´ -->
{% if workspace.status == 'CLOSED' and not is_admin %}
<div id="closed-overlay" class="closed-overlay">
  <div class="closed-message">ì´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ëŠ” ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
</div>
{% endif %}

<!-- workspace ë°ì´í„° -->
<!-- ì‹œíŠ¸ ì´ë¦„ë³€ê²½ ëª¨ë‹¬ -->
<template id="rename-ws-sheet-tpl">
  <form onsubmit="submitRenameWsSheet(event)" style="display:flex;flex-direction:column;gap:12px">
    <div class="form-group">
      <label>ì‹œíŠ¸ ì´ë¦„</label>
      <input type="text" id="f-ws-sheet-name" required>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-ghost" onclick="closeModal()">ì·¨ì†Œ</button>
      <button type="submit" class="btn btn-primary">ë³€ê²½</button>
    </div>
  </form>
</template>

<script id="workspace-data" type="application/json">{{ workspace_data_json | safe }}</script>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsuites/dist/jsuites.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@jspreadsheet/formula@2/dist/index.js"></script>
<script>
  const IS_ADMIN = {{ 'true' if is_admin else 'false' }};
  const CURRENT_USER = {{ current_user.username | tojson }};
</script>
<script src="/static/js/workspace.js"></script>
{% endblock %}
