{% extends "layout.html" %}
{% block title %}대시보드 - OpenSpace{% endblock %}
{% block page_title %}대시보드{% endblock %}

{% block content %}

{% if current_user.must_change_password %}
<div class="alert alert-warning" id="pw-change-alert">
  <strong>보안 경고:</strong> 초기 비밀번호를 사용 중입니다.
  <a href="#" onclick="openPasswordModal(); document.getElementById('pw-change-alert').style.display='none'; return false;">지금 비밀번호를 변경하세요.</a>
</div>
{% endif %}

<div class="stat-cards">
  <div class="stat-card">
    <div class="stat-value">{{ user_count }}</div>
    <div class="stat-label">전체 사용자</div>
  </div>
  {% if is_admin %}
  <div class="stat-card">
    <div class="stat-value">{{ tmpl_count }}</div>
    <div class="stat-label">서식 수</div>
  </div>
  {% endif %}
  <div class="stat-card">
    <div class="stat-value">{{ ws_count }}</div>
    <div class="stat-label">워크스페이스</div>
  </div>
</div>

<section class="section">
  <h2>열린 워크스페이스</h2>
  {% if open_workspaces %}
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>이름</th>
          <th>시트 수</th>
        </tr>
      </thead>
      <tbody>
        {% for ws in open_workspaces %}
        <tr>
          <td><a href="/workspaces/{{ ws.id }}" style="color:var(--primary); font-weight:500">{{ ws.name }}</a></td>
          <td>{{ ws.sheets|length }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="empty-msg">열린 워크스페이스가 없습니다.</p>
  {% endif %}
</section>

{% if is_admin and recent_logs %}
<section class="section">
  <h2>최근 변경 이력</h2>
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>사용자</th>
          <th>워크스페이스</th>
          <th>셀</th>
          <th>이전 값</th>
          <th>변경 값</th>
          <th>변경 시각</th>
        </tr>
      </thead>
      <tbody>
        {% for log in recent_logs %}
        <tr>
          <td>{{ log.username }}</td>
          <td><a href="/workspaces/{{ log.workspace_id }}">{{ log.workspace_name }}</a></td>
          <td class="mono">{{ log.cell }}</td>
          <td class="text-muted">{{ log.old_value or '' }}</td>
          <td>{{ log.new_value or '' }}</td>
          <td class="text-muted small">{{ log.changed_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

{% endblock %}
