{% extends "layout.html" %}
{% block title %}{{ template.name }} í¸ì§‘ - OpenSpace{% endblock %}
{% block page_title %}ì„œì‹ í¸ì§‘: {{ template.name }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsuites/dist/jsuites.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4/dist/jspreadsheet.css">
<style>
.editor-topbar { display:flex; align-items:center; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
.editor-topbar .left { flex:1; display:flex; align-items:center; gap:8px; }
.sheet-tabs-wrap { display:flex; align-items:center; gap:2px; border-bottom:2px solid var(--border); padding-bottom:0; margin-bottom:4px; overflow-x:auto; }
.sheet-tab { display:flex; align-items:center; gap:4px; padding:5px 12px; border:1px solid var(--border); border-bottom:none; border-radius:4px 4px 0 0; cursor:pointer; font-size:13px; background:var(--bg); white-space:nowrap; }
.sheet-tab.active { background:var(--surface); border-color:var(--primary); color:var(--primary); font-weight:600; }
.sheet-tab .tab-del { font-size:14px; color:#94a3b8; cursor:pointer; padding:0 2px; line-height:1; }
.sheet-tab .tab-del:hover { color:var(--danger); }
.sheet-add-btn { padding:5px 10px; border:1px dashed var(--border); border-radius:4px; cursor:pointer; font-size:18px; color:var(--text-muted); background:none; }
.sheet-add-btn:hover { color:var(--primary); border-color:var(--primary); }

/* ì»¬ëŸ¼ ì†ì„± íŒ¨ë„ */
.col-panel { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:12px; margin-bottom:8px; display:none; }
.col-panel.visible { display:block; }
.col-panel-title { font-weight:600; margin-bottom:10px; font-size:13px; color:var(--text-muted); }
.col-panel-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.col-panel-row label { font-size:12px; font-weight:500; min-width:60px; }
.col-panel-row input, .col-panel-row select { padding:4px 8px; border:1px solid var(--border); border-radius:4px; font-size:13px; }
.col-panel-row input[type=number] { width:80px; }
.col-panel-row .sep { color:var(--border); }

#spreadsheet-wrap { position:relative; }
.save-indicator { position:fixed; bottom:16px; right:16px; background:#0f172a; color:#fff; padding:6px 14px; border-radius:20px; font-size:12px; opacity:0; transition:opacity .3s; pointer-events:none; z-index:999; }
.save-indicator.show { opacity:1; }
</style>
{% endblock %}

{% block content %}
<!-- ìƒë‹¨ íˆ´ë°” -->
<div class="editor-topbar">
  <div class="left">
    <a href="/admin/templates" class="btn btn-ghost btn-sm">â† ëª©ë¡</a>
    <span style="color:var(--text-muted)">|</span>
    <strong id="tmpl-name-display">{{ template.name }}</strong>
  </div>
  <div style="display:flex;gap:6px;flex-wrap:wrap">
    <button class="btn btn-sm btn-secondary" onclick="addColumn()">+ ì»¬ëŸ¼ ì¶”ê°€</button>
    <button class="btn btn-sm btn-secondary" onclick="showColPanel()">ì»¬ëŸ¼ ì†ì„±</button>
    <button class="btn btn-sm btn-secondary" onclick="downloadTemplate()">xlsx ë‹¤ìš´ë¡œë“œ</button>
    <span id="save-status" style="font-size:12px;color:var(--text-muted);align-self:center"></span>
  </div>
</div>

<!-- ì»¬ëŸ¼ ì†ì„± íŒ¨ë„ -->
<div class="col-panel" id="col-panel">
  <div class="col-panel-title">ì„ íƒ ì»¬ëŸ¼ ì†ì„± (ì»¬ëŸ¼ í—¤ë” í´ë¦­ í›„ ì ìš©)</div>
  <div class="col-panel-row">
    <label>í—¤ë”ëª…</label>
    <input type="text" id="cp-header" placeholder="ì»¬ëŸ¼ëª…">
    <span class="sep">|</span>
    <label>íƒ€ì…</label>
    <select id="cp-type">
      <option value="text">í…ìŠ¤íŠ¸</option>
      <option value="number">ìˆ«ì</option>
      <option value="date">ë‚ ì§œ</option>
      <option value="checkbox">ì²´í¬ë°•ìŠ¤</option>
    </select>
    <span class="sep">|</span>
    <label>ë„ˆë¹„</label>
    <input type="number" id="cp-width" value="120" min="40" max="500">
    <span class="sep">|</span>
    <label style="min-width:auto"><input type="checkbox" id="cp-readonly"> ì½ê¸°ì „ìš©</label>
    <button class="btn btn-sm btn-primary" onclick="applyColProps()">ì ìš©</button>
    <button class="btn btn-sm btn-danger" onclick="deleteColumn()">ì»¬ëŸ¼ ì‚­ì œ</button>
  </div>
</div>

<!-- ì‹œíŠ¸ íƒ­ -->
<div class="sheet-tabs-wrap" id="sheet-tabs"></div>

<!-- í¬ë§· íˆ´ë°” -->
<div class="format-toolbar" id="format-toolbar">
  <button class="fmt-btn" id="fmt-bold" title="êµµê²Œ (Bold)" onclick="fmtBold()"><b>B</b></button>
  <button class="fmt-btn" id="fmt-italic" title="ê¸°ìš¸ì„ (Italic)" onclick="fmtItalic()"><i>I</i></button>
  <button class="fmt-btn" id="fmt-underline" title="ë°‘ì¤„ (Underline)" onclick="fmtUnderline()"><u>U</u></button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-color" title="ê¸€ììƒ‰" onclick="toggleDropdown('color-drop')" style="position:relative">
    A<span class="color-bar" id="fmt-color-bar" style="background:#000000"></span>
    <div class="fmt-dropdown" id="color-drop">
      <div class="color-swatches" id="color-swatches"></div>
      <div class="fmt-dropdown-item" onclick="fmtColor(null)">ìë™ (ê¸°ë³¸ìƒ‰)</div>
    </div>
  </button>
  <button class="fmt-btn" id="fmt-bg" title="ë°°ê²½ìƒ‰" onclick="toggleDropdown('bg-drop')" style="position:relative">
    ğŸ¨<span class="color-bar" id="fmt-bg-bar" style="background:transparent;border:1px solid #ccc"></span>
    <div class="fmt-dropdown" id="bg-drop">
      <div class="color-swatches" id="bg-swatches"></div>
      <div class="fmt-dropdown-item" onclick="fmtBg(null)">ì—†ìŒ (ë°°ê²½ ì œê±°)</div>
    </div>
  </button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-align-left" title="ì™¼ìª½ ì •ë ¬" onclick="fmtAlign('left')">â¬…</button>
  <button class="fmt-btn" id="fmt-align-center" title="ê°€ìš´ë° ì •ë ¬" onclick="fmtAlign('center')">â‰¡</button>
  <button class="fmt-btn" id="fmt-align-right" title="ì˜¤ë¥¸ìª½ ì •ë ¬" onclick="fmtAlign('right')">â¡</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" id="fmt-wrap" title="ì¤„ë°”ê¿ˆ" onclick="fmtWrap()">â†µ</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" title="ì…€ ë³‘í•©" onclick="fmtMerge()">âŠ</button>
  <button class="fmt-btn" title="ë³‘í•© í•´ì œ" onclick="fmtUnmerge()">âŠŸ</button>
  <div class="fmt-sep"></div>
  <button class="fmt-btn" title="í…Œë‘ë¦¬" onclick="toggleDropdown('border-drop')" style="position:relative">
    âŠ¡
    <div class="fmt-dropdown" id="border-drop">
      <div class="fmt-dropdown-item" onclick="fmtBorder('all')">ëª¨ë“  í…Œë‘ë¦¬</div>
      <div class="fmt-dropdown-item" onclick="fmtBorder('outer')">ë°”ê¹¥ í…Œë‘ë¦¬</div>
      <div class="fmt-dropdown-item" onclick="fmtBorder('none')">í…Œë‘ë¦¬ ì—†ìŒ</div>
      <div class="fmt-dropdown-item" onclick="fmtBorder('bottom')">ì•„ë˜ìª½ë§Œ</div>
    </div>
  </button>
</div>

<!-- ìŠ¤í”„ë ˆë“œì‹œíŠ¸ -->
<div id="spreadsheet-wrap">
  <div id="spreadsheet"></div>
</div>

<div class="save-indicator" id="save-indicator">ì €ì¥ ì¤‘...</div>

<!-- ì‹œíŠ¸ ì´ë¦„ ë³€ê²½ ëª¨ë‹¬ -->
<template id="rename-sheet-tpl">
  <form onsubmit="submitRenameSheet(event)" style="display:flex;flex-direction:column;gap:12px">
    <div class="form-group">
      <label>ì‹œíŠ¸ ì´ë¦„</label>
      <input type="text" id="f-sheet-name" required>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-ghost" onclick="closeModal()">ì·¨ì†Œ</button>
      <button type="submit" class="btn btn-primary">ë³€ê²½</button>
    </div>
  </form>
</template>

<script id="template-data" type="application/json">{{ template_data_json | safe }}</script>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsuites/dist/jsuites.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspreadsheet-ce@4/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@jspreadsheet/formula@2/dist/index.js"></script>
<script src="/static/js/template_edit.js"></script>
{% endblock %}
